
<!doctype html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Processador de Frequência - Demo</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
	<style>
		body{font-family:Roboto,Arial;background:#e6f0fb;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
		.card{background:#fff;padding:28px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08);width:520px}
		h1{font-size:20px;margin:0 0 16px;color:#114a6b}
		label{display:block;margin-top:12px;font-size:13px;color:#333}
		input[type=file]{margin-top:6px}
		select,input[type=date],button{width:100%;padding:10px;border-radius:6px;border:1px solid #cfdde9;margin-top:6px}
		.row{display:flex;gap:10px}
		.row > *{flex:1}
		#colsContainer{max-height:140px;overflow:auto;border:1px dashed #ddd;padding:8px;border-radius:6px;background:#fbfeff}
		.help{font-size:13px;color:#226; margin-top:8px}
		.message{margin-top:14px;padding:12px;border-radius:6px;background:#eef8ee;color:#0a6b1f;display:none}
		.btn-primary{background:linear-gradient(180deg,#2b6a8a,#1f4f67);color:#fff;border:none;cursor:pointer}
	</style>
</head>
<body>
	<div class="card">
		<h1>Processador de Frequência (demo)</h1>

		<label>Arquivo Empresa (CSV)<br><small style="color:#666">Selecione o arquivo CSV (delimitador ;)</small></label>
		<input id="fileEmpresa" type="file" accept="text/csv" />

		<label>Empresa</label>
		<select id="empresaSelect"><option value="Todas">Todas</option></select>

		<label>Turma</label>
		<select id="turmaSelect"><option value="Todas">Todas</option></select>

		<label>Data (Período)</label>
		<div class="row">
			<input id="dateStart" type="date" />
			<input id="dateEnd" type="date" />
		</div>

		<label>Campos a incluir no relatório</label>
		<div id="colsContainer">Nenhum arquivo carregado.</div>

		<button id="processBtn" class="btn-primary" style="margin-top:12px">Processar e Gerar Relatório</button>

		<div id="message" class="message">Relatório gerado com sucesso!</div>
		<div class="help">Observação: o CSV de exemplo usa ponto-e-vírgula (;) como separador. Abra a página no navegador e selecione o arquivo.</div>
	</div>

	<!-- Dependências: PapaParse para parsing robusto e SheetJS para gerar Excel -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script>
		// Estado
		let rawData = [];
		let headers = [];

		const fileInput = document.getElementById('fileEmpresa');
		const empresaSelect = document.getElementById('empresaSelect');
		const turmaSelect = document.getElementById('turmaSelect');
		const colsContainer = document.getElementById('colsContainer');
		const processBtn = document.getElementById('processBtn');
		const message = document.getElementById('message');
		const dateStart = document.getElementById('dateStart');
		const dateEnd = document.getElementById('dateEnd');

		function resetUI(){
			empresaSelect.innerHTML = '<option value="Todas">Todas</option>';
			turmaSelect.innerHTML = '<option value="Todas">Todas</option>';
			colsContainer.innerHTML = 'Nenhum arquivo carregado.';
			rawData = [];
			headers = [];
		}

		// Parse do CSV usando PapaParse (delimiter ; e header true)
		fileInput.addEventListener('change', (e)=>{
			const f = e.target.files[0];
			if(!f){ resetUI(); return; }
			Papa.parse(f, {
				delimiter: ';',
				header: true,
				skipEmptyLines: true,
				encoding: 'utf-8',
				complete: function(results){
					rawData = results.data || [];
					headers = results.meta.fields || [];
					setupSelectors();
				},
				error: function(err){
					alert('Erro ao ler CSV: '+err);
				}
			});
		});

		function unique(values){ return Array.from(new Set(values.filter(v=>v!=null && v!==''))); }

		function setupSelectors(){
			// Popular empresaSelect a partir da coluna 'EMPRESA' (ou outras tentativas)
			const empresaField = headers.find(h=>h.toUpperCase().trim().includes('EMPRESA')) || 'EMPRESA';
			const turmaField = headers.find(h=>h.toUpperCase().trim().includes('TURMA')) || 'TURMA';

			const empresas = unique(rawData.map(r=>r[empresaField] || '').map(s=>s.trim()));
			empresaSelect.innerHTML = '<option value="Todas">Todas</option>' + empresas.map(e=>`<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join('');

			// Turmas (todas inicialmente)
			const turmas = unique(rawData.map(r=>r[turmaField] || '').map(s=>s.trim()));
			turmaSelect.innerHTML = '<option value="Todas">Todas</option>' + turmas.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

			// Campos
			colsContainer.innerHTML = '';
			headers.forEach(h=>{
				const id = 'col_' + h.replace(/[^a-z0-9]/gi,'_');
				const checked = ['ALUNO','CPF','DATA','FALTAS','FREQUENCIA','TURMA','EMPRESA'].some(k=>h.toUpperCase().includes(k)) ? 'checked' : '';
				const div = document.createElement('div');
				div.innerHTML = `<label style="font-size:13px"><input type="checkbox" ${checked} data-col="${escapeHtml(h)}" id="${id}" /> ${escapeHtml(h)}</label>`;
				colsContainer.appendChild(div);
			});
		}

		empresaSelect.addEventListener('change', ()=>{
			// Ao trocar empresa, filtrar turmas disponíveis
			const empresaField = headers.find(h=>h.toUpperCase().trim().includes('EMPRESA')) || 'EMPRESA';
			const turmaField = headers.find(h=>h.toUpperCase().trim().includes('TURMA')) || 'TURMA';
			const sel = empresaSelect.value;
			let lista = rawData;
			if(sel && sel !== 'Todas') lista = rawData.filter(r=> (r[empresaField]||'').trim() === sel);
			const turmas = unique(lista.map(r=> (r[turmaField]||'').trim()));
			turmaSelect.innerHTML = '<option value="Todas">Todas</option>' + turmas.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
		});

		function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

		function parseBRDate(str){ // dd/mm/yyyy -> Date
			if(!str) return null;
			const parts = str.split('/');
			if(parts.length!==3) return new Date(str);
			const d = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, y = parseInt(parts[2],10);
			return new Date(y,m,d);
		}

		processBtn.addEventListener('click', ()=>{
			if(!rawData.length){ alert('Carregue um arquivo CSV primeiro.'); return; }

			const empresaField = headers.find(h=>h.toUpperCase().trim().includes('EMPRESA')) || 'EMPRESA';
			const turmaField = headers.find(h=>h.toUpperCase().trim().includes('TURMA')) || 'TURMA';
			const dataField = headers.find(h=>h.toUpperCase().trim()=== 'DATA') || headers.find(h=>h.toUpperCase().includes('DATA')) || 'DATA';

			const selEmpresa = empresaSelect.value;
			const selTurma = turmaSelect.value;

			const start = dateStart.value ? new Date(dateStart.value) : null;
			const end = dateEnd.value ? new Date(dateEnd.value) : null;
			if(start && end && end < start){ alert('Período inválido: a data final é anterior à inicial.'); return; }

			// Colunas selecionadas
			const checkedBoxes = Array.from(colsContainer.querySelectorAll('input[type=checkbox]:checked'));
			const selectedCols = checkedBoxes.map(cb=>cb.getAttribute('data-col'));
			if(selectedCols.length===0){ if(!confirm('Nenhum campo selecionado — deseja incluir todas as colunas?')) return; selectedCols.push(...headers); }

			// Filtrar
			const filtered = rawData.filter(row=>{
				// Empresa
				if(selEmpresa && selEmpresa !== 'Todas'){
					const val = (row[empresaField]||'').trim(); if(val !== selEmpresa) return false;
				}
				// Turma
				if(selTurma && selTurma !== 'Todas'){
					const val = (row[turmaField]||'').trim(); if(val !== selTurma) return false;
				}
				// Data
				if((start || end) && row[dataField]){
					const dt = parseBRDate((row[dataField]||'').trim());
					if(!dt || isNaN(dt)) return false;
					if(start && dt < start) return false;
					if(end && dt > new Date(end.getFullYear(), end.getMonth(), end.getDate(),23,59,59)) return false;
				}
				return true;
			});

			// Preparar dados para Excel apenas com colunas selecionadas
			const out = filtered.map(r => {
				const obj = {};
				selectedCols.forEach(c => { obj[c] = r[c]; });
				return obj;
			});

			// Gerar XLSX via SheetJS
			try{
				const ws = XLSX.utils.json_to_sheet(out, {header: selectedCols});
				const wb = XLSX.utils.book_new();
				XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
				const filename = `relatorio_${(new Date()).toISOString().slice(0,10)}.xlsx`;
				XLSX.writeFile(wb, filename);
				message.style.display = 'block';
				setTimeout(()=>message.style.display='none',4000);
			}catch(err){
				alert('Erro ao gerar Excel: ' + err);
			}
		});
	</script>
</body>
</html>
